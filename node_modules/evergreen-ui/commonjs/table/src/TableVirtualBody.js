"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reactTinyVirtualList = _interopRequireDefault(require("react-tiny-virtual-list"));

var _lodash = _interopRequireDefault(require("lodash.debounce"));

var _layers = require("../../layers");

var TableVirtualBody =
/*#__PURE__*/
function (_PureComponent) {
  (0, _inherits2.default)(TableVirtualBody, _PureComponent);
  (0, _createClass2.default)(TableVirtualBody, null, [{
    key: "getDerivedStateFromProps",
    value: function getDerivedStateFromProps(props, state) {
      if (props.height !== state.calculatedHeight) {
        return {
          isIntegerHeight: Number.isInteger(props.height)
        };
      } // Return null to indicate no change to state.


      return null;
    }
  }]);

  function TableVirtualBody(props) {
    var _this;

    (0, _classCallCheck2.default)(this, TableVirtualBody);
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(TableVirtualBody).call(this, props));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "state", {
      isIntegerHeight: false,
      calculatedHeight: 0
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "initializeHelpers", function () {
      _this.autoHeights = [];
      _this.autoHeightRefs = [];
      _this.averageAutoHeight = _this.props.defaultHeight;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "processAutoHeights", function () {
      var isUpdated = false; // This will determine the averageAutoHeight.

      var total = 0;
      var totalAmount = 0; // Loop through all of the refs that have height="auto".

      _this.autoHeightRefs.forEach(function (ref, index) {
        // If the height is already calculated, skip it,
        // but calculate the height for the total.
        if (_this.autoHeights[index]) {
          total += _this.autoHeights[index];
          totalAmount += 1;
          return;
        } // Make sure the ref has a child


        if (ref && ref.childNodes && ref.childNodes[0] && Number.isInteger(ref.childNodes[0].offsetHeight)) {
          var height = ref.childNodes[0].offsetHeight; // Add to the total to calculate the averageAutoHeight.

          total += height;
          totalAmount += 1; // Cache the height.

          _this.autoHeights[index] = height; // Set the update flag to true.

          isUpdated = true;
        }
      }); // Save the average height.


      _this.averageAutoHeight = total / totalAmount; // There are some new heights detected that had previously not been calculated.
      // Call forceUpdate to make sure the virtual list renders again.

      if (isUpdated) _this.forceUpdate();
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onRef", function (ref) {
      _this.paneRef = ref;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onVirtualHelperRef", function (index, ref) {
      _this.autoHeightRefs[index] = ref;
      requestAnimationFrame(function () {
        _this.processAutoHeights();
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onResize", function () {
      _this.updateOnResize();
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "updateOnResize", function () {
      _this.initializeHelpers(); // Simply return when we now the height of the pane is fixed.


      if (_this.state.isIntegerHeight) return; // Return if we are in a weird edge case in which the ref is no longer valid.

      if (_this.paneRef) {
        var calculatedHeight = _this.paneRef.offsetHeight;

        if (calculatedHeight > 0) {
          // Save the calculated height which is needed for the VirtualList.
          _this.setState({
            calculatedHeight: calculatedHeight
          }); // Prevent updateOnResize being called recursively when there is a valid height.


          return;
        }
      } // When height is still 0 (or paneRef is not valid) try recursively until success.


      requestAnimationFrame(function () {
        _this.updateOnResize();
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "getItemSize", function (children) {
      var _this$props = _this.props,
          allowAutoHeight = _this$props.allowAutoHeight,
          useAverageAutoHeightEstimation = _this$props.useAverageAutoHeightEstimation,
          defaultHeight = _this$props.defaultHeight; // Prefer to return a array of all heights.

      if (!allowAutoHeight) {
        return children.map(function (child) {
          if (!_react.default.isValidElement(child)) return defaultHeight;
          var height = child.props.height;

          if (Number.isInteger(height)) {
            return height;
          }

          return defaultHeight;
        });
      } // If allowAutoHeight is true, return a function instead.


      var itemSizeFn = function itemSizeFn(index) {
        if (!_react.default.isValidElement(children[index])) return defaultHeight;
        var height = children[index].props.height; // When the height is number simply, simply return it.

        if (Number.isInteger(height)) {
          return height;
        } // When allowAutoHeight is set and  the height is set to "auto"...


        if (allowAutoHeight && children[index].props.height === 'auto') {
          // ... and the height is calculated, return the calculated height.
          if (_this.autoHeights[index]) return _this.autoHeights[index]; // ... if the height is not yet calculated, return the averge

          if (useAverageAutoHeightEstimation) return _this.averageAutoHeight;
        } // Return the default height.


        return defaultHeight;
      };

      return itemSizeFn;
    });

    _this.initializeHelpers(); // Add a onResize.


    _this.onResize = (0, _lodash.default)(_this.onResize, 200);
    return _this;
  }

  (0, _createClass2.default)(TableVirtualBody, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      // Call this to initialize and set
      this.updateOnResize();
      window.addEventListener('resize', this.onResize, false);
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      window.removeEventListener('resize', this.onResize);
    }
  }, {
    key: "render",
    value: function render() {
      var _this2 = this;

      var _this$props2 = this.props,
          inputChildren = _this$props2.children,
          paneHeight = _this$props2.height,
          defaultHeight = _this$props2.defaultHeight,
          allowAutoHeight = _this$props2.allowAutoHeight,
          overscanCount = _this$props2.overscanCount,
          estimatedItemSize = _this$props2.estimatedItemSize,
          useAverageAutoHeightEstimation = _this$props2.useAverageAutoHeightEstimation,
          props = (0, _objectWithoutProperties2.default)(_this$props2, ["children", "height", "defaultHeight", "allowAutoHeight", "overscanCount", "estimatedItemSize", "useAverageAutoHeightEstimation"]); // Children always needs to be an array.

      var children = Array.isArray(inputChildren) ? inputChildren : _react.default.Children.toArray(inputChildren);
      var itemSize = this.getItemSize(children); // VirtualList needs a fixed height.

      var _this$state = this.state,
          calculatedHeight = _this$state.calculatedHeight,
          isIntegerHeight = _this$state.isIntegerHeight;
      return _react.default.createElement(_layers.Pane, (0, _extends2.default)({
        "data-evergreen-table-body": true,
        innerRef: this.onRef,
        height: paneHeight,
        flex: "1",
        overflow: "hidden"
      }, props), _react.default.createElement(_reactTinyVirtualList.default, {
        height: isIntegerHeight ? paneHeight : calculatedHeight,
        width: "100%",
        estimatedItemSize: allowAutoHeight && useAverageAutoHeightEstimation ? this.averageAutoHeight : estimatedItemSize || null,
        itemSize: itemSize,
        overscanCount: overscanCount,
        itemCount: _react.default.Children.count(children),
        renderItem: function renderItem(_ref) {
          var index = _ref.index,
              style = _ref.style;

          // If some children are strings by accident, support this gracefully.
          if (!_react.default.isValidElement(children[index])) {
            if (typeof children[index] === 'string') {
              return _react.default.createElement("div", {
                style: style
              }, children[index]);
            }

            return _react.default.createElement("div", {
              style: style
            }, "\xA0");
          } // When allowing height="auto" for rows, and a auto height item is
          // rendered for the first time...


          if (allowAutoHeight && _react.default.isValidElement(children[index]) && children[index].props.height === 'auto' && // ... and only when the height is not already been calculated.
          !_this2.autoHeights[index]) {
            // ... render the item in a helper div, the ref is used to calculate
            // the height of its children.
            return _react.default.createElement("div", {
              ref: function ref(_ref2) {
                return _this2.onVirtualHelperRef(index, _ref2);
              },
              "data-virtual-index": index,
              style: (0, _objectSpread2.default)({
                opacity: 0
              }, style)
            }, children[index]);
          } // When allowAutoHeight is false, or when the height is known.
          // Simply render the item.


          return _react.default.cloneElement(children[index], {
            style: style
          });
        }
      }));
    }
  }]);
  return TableVirtualBody;
}(_react.PureComponent);

exports.default = TableVirtualBody;
TableVirtualBody.displayName = "TableVirtualBody";
(0, _defineProperty2.default)(TableVirtualBody, "propTypes", (0, _objectSpread2.default)({}, _layers.Pane.propTypes, {
  /**
   * Children needs to be an array of a single node.
   */
  children: _propTypes.default.oneOfType([_propTypes.default.arrayOf(_propTypes.default.node), _propTypes.default.node]),

  /**
   * Default height of each row.
   * 48 is the default height of a TableRow.
   */
  defaultHeight: _propTypes.default.number,

  /**
   * When true, support `height="auto"` on children being rendered.
   * This is somewhat of an expirmental feature.
   */
  allowAutoHeight: _propTypes.default.bool,

  /**
   * The overscanCount property passed to react-tiny-virtual-list.
   */
  overscanCount: _propTypes.default.number.isRequired,

  /**
   * When passed, this is used as the `estimatedItemSize` in react-tiny-virtual-list.
   * Only when `allowAutoHeight` and`useAverageAutoHeightEstimation` are false.
   */
  estimatedItemSize: _propTypes.default.number,

  /**
   * When allowAutoHeight is true and this prop is true, the estimated height
   * will be computed based on the average height of auto height rows.
   */
  useAverageAutoHeightEstimation: _propTypes.default.bool
}));
(0, _defineProperty2.default)(TableVirtualBody, "defaultProps", {
  defaultHeight: 48,
  allowAutoHeight: false,
  overscanCount: 5,
  useAverageAutoHeightEstimation: true
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvVGFibGVWaXJ0dWFsQm9keS5qcyJdLCJuYW1lcyI6WyJUYWJsZVZpcnR1YWxCb2R5IiwicHJvcHMiLCJzdGF0ZSIsImhlaWdodCIsImNhbGN1bGF0ZWRIZWlnaHQiLCJpc0ludGVnZXJIZWlnaHQiLCJOdW1iZXIiLCJpc0ludGVnZXIiLCJhdXRvSGVpZ2h0cyIsImF1dG9IZWlnaHRSZWZzIiwiYXZlcmFnZUF1dG9IZWlnaHQiLCJkZWZhdWx0SGVpZ2h0IiwiaXNVcGRhdGVkIiwidG90YWwiLCJ0b3RhbEFtb3VudCIsImZvckVhY2giLCJyZWYiLCJpbmRleCIsImNoaWxkTm9kZXMiLCJvZmZzZXRIZWlnaHQiLCJmb3JjZVVwZGF0ZSIsInBhbmVSZWYiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJwcm9jZXNzQXV0b0hlaWdodHMiLCJ1cGRhdGVPblJlc2l6ZSIsImluaXRpYWxpemVIZWxwZXJzIiwic2V0U3RhdGUiLCJjaGlsZHJlbiIsImFsbG93QXV0b0hlaWdodCIsInVzZUF2ZXJhZ2VBdXRvSGVpZ2h0RXN0aW1hdGlvbiIsIm1hcCIsImNoaWxkIiwiUmVhY3QiLCJpc1ZhbGlkRWxlbWVudCIsIml0ZW1TaXplRm4iLCJvblJlc2l6ZSIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiaW5wdXRDaGlsZHJlbiIsInBhbmVIZWlnaHQiLCJvdmVyc2NhbkNvdW50IiwiZXN0aW1hdGVkSXRlbVNpemUiLCJBcnJheSIsImlzQXJyYXkiLCJDaGlsZHJlbiIsInRvQXJyYXkiLCJpdGVtU2l6ZSIsImdldEl0ZW1TaXplIiwib25SZWYiLCJjb3VudCIsInN0eWxlIiwib25WaXJ0dWFsSGVscGVyUmVmIiwib3BhY2l0eSIsImNsb25lRWxlbWVudCIsIlB1cmVDb21wb25lbnQiLCJQYW5lIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwib25lT2ZUeXBlIiwiYXJyYXlPZiIsIm5vZGUi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RixDQURGO0FBK0REOzs7RUE5VDJDSSxvQjs7O0FBQXpCdkQsZ0I7OEJBQUFBLGdCLCtDQUtkd0QsYUFBS0MsUztBQUVSOzs7QUFHQTlCLEVBQUFBLFFBQVEsRUFBRStCLG1CQUFVQyxTQUFWLENBQW9CLENBQzVCRCxtQkFBVUUsT0FBVixDQUFrQkYsbUJBQVVHLElBQTVCLENBRDRCLEVBRTVCSCxtQkFBVUcsSUFGa0IsQ0FBcEIsQzs7QUFLVjs7OztBQUlBbEQsRUFBQUEsYUFBYSxFQUFFK0MsbUJBQVVJLE07O0FBRXpCOzs7O0FBSUFsQyxFQUFBQSxlQUFlLEVBQUU4QixtQkFBVUssSTs7QUFFM0I7OztBQUdBdEIsRUFBQUEsYUFBYSxFQUFFaUIsbUJBQVVJLE1BQVYsQ0FBaUJFLFU7O0FBRWhDOzs7O0FBSUF0QixFQUFBQSxpQkFBaUIsRUFBRWdCLG1CQUFVSSxNOztBQUU3Qjs7OztBQUlBakMsRUFBQUEsOEJBQThCLEVBQUU2QixtQkFBVUs7OzhCQTFDekIvRCxnQixrQkE2Q0c7QUFDcEJXLEVBQUFBLGFBQWEsRUFBRSxFQURLO0FBRXBCaUIsRUFBQUEsZUFBZSxFQUFFLEtBRkc7QUFHcEJhLEVBQUFBLGFBQWEsRUFBRSxDQUhLO0FBSXBCWixFQUFBQSw4QkFBOEIsRUFBRTtBQUpaLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgUHVyZUNvbXBvbmVudCB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IFZpcnR1YWxMaXN0IGZyb20gJ3JlYWN0LXRpbnktdmlydHVhbC1saXN0J1xuaW1wb3J0IGRlYm91bmNlIGZyb20gJ2xvZGFzaC5kZWJvdW5jZSdcbmltcG9ydCB7IFBhbmUgfSBmcm9tICcuLi8uLi9sYXllcnMnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRhYmxlVmlydHVhbEJvZHkgZXh0ZW5kcyBQdXJlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAvKipcbiAgICAgKiBDb21wb3NlcyB0aGUgUGFuZSBjb21wb25lbnQgYXMgdGhlIGJhc2UuXG4gICAgICovXG4gICAgLi4uUGFuZS5wcm9wVHlwZXMsXG5cbiAgICAvKipcbiAgICAgKiBDaGlsZHJlbiBuZWVkcyB0byBiZSBhbiBhcnJheSBvZiBhIHNpbmdsZSBub2RlLlxuICAgICAqL1xuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICAgIFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5ub2RlKSxcbiAgICAgIFByb3BUeXBlcy5ub2RlXG4gICAgXSksXG5cbiAgICAvKipcbiAgICAgKiBEZWZhdWx0IGhlaWdodCBvZiBlYWNoIHJvdy5cbiAgICAgKiA0OCBpcyB0aGUgZGVmYXVsdCBoZWlnaHQgb2YgYSBUYWJsZVJvdy5cbiAgICAgKi9cbiAgICBkZWZhdWx0SGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gICAgLyoqXG4gICAgICogV2hlbiB0cnVlLCBzdXBwb3J0IGBoZWlnaHQ9XCJhdXRvXCJgIG9uIGNoaWxkcmVuIGJlaW5nIHJlbmRlcmVkLlxuICAgICAqIFRoaXMgaXMgc29tZXdoYXQgb2YgYW4gZXhwaXJtZW50YWwgZmVhdHVyZS5cbiAgICAgKi9cbiAgICBhbGxvd0F1dG9IZWlnaHQ6IFByb3BUeXBlcy5ib29sLFxuXG4gICAgLyoqXG4gICAgICogVGhlIG92ZXJzY2FuQ291bnQgcHJvcGVydHkgcGFzc2VkIHRvIHJlYWN0LXRpbnktdmlydHVhbC1saXN0LlxuICAgICAqL1xuICAgIG92ZXJzY2FuQ291bnQ6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFdoZW4gcGFzc2VkLCB0aGlzIGlzIHVzZWQgYXMgdGhlIGBlc3RpbWF0ZWRJdGVtU2l6ZWAgaW4gcmVhY3QtdGlueS12aXJ0dWFsLWxpc3QuXG4gICAgICogT25seSB3aGVuIGBhbGxvd0F1dG9IZWlnaHRgIGFuZGB1c2VBdmVyYWdlQXV0b0hlaWdodEVzdGltYXRpb25gIGFyZSBmYWxzZS5cbiAgICAgKi9cbiAgICBlc3RpbWF0ZWRJdGVtU2l6ZTogUHJvcFR5cGVzLm51bWJlcixcblxuICAgIC8qKlxuICAgICAqIFdoZW4gYWxsb3dBdXRvSGVpZ2h0IGlzIHRydWUgYW5kIHRoaXMgcHJvcCBpcyB0cnVlLCB0aGUgZXN0aW1hdGVkIGhlaWdodFxuICAgICAqIHdpbGwgYmUgY29tcHV0ZWQgYmFzZWQgb24gdGhlIGF2ZXJhZ2UgaGVpZ2h0IG9mIGF1dG8gaGVpZ2h0IHJvd3MuXG4gICAgICovXG4gICAgdXNlQXZlcmFnZUF1dG9IZWlnaHRFc3RpbWF0aW9uOiBQcm9wVHlwZXMuYm9vbFxuICB9XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBkZWZhdWx0SGVpZ2h0OiA0OCxcbiAgICBhbGxvd0F1dG9IZWlnaHQ6IGZhbHNlLFxuICAgIG92ZXJzY2FuQ291bnQ6IDUsXG4gICAgdXNlQXZlcmFnZUF1dG9IZWlnaHRFc3RpbWF0aW9uOiB0cnVlXG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICBpc0ludGVnZXJIZWlnaHQ6IGZhbHNlLFxuICAgIGNhbGN1bGF0ZWRIZWlnaHQ6IDBcbiAgfVxuXG4gIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMocHJvcHMsIHN0YXRlKSB7XG4gICAgaWYgKHByb3BzLmhlaWdodCAhPT0gc3RhdGUuY2FsY3VsYXRlZEhlaWdodCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNJbnRlZ2VySGVpZ2h0OiBOdW1iZXIuaXNJbnRlZ2VyKHByb3BzLmhlaWdodClcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBSZXR1cm4gbnVsbCB0byBpbmRpY2F0ZSBubyBjaGFuZ2UgdG8gc3RhdGUuXG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpXG5cbiAgICB0aGlzLmluaXRpYWxpemVIZWxwZXJzKClcblxuICAgIC8vIEFkZCBhIG9uUmVzaXplLlxuICAgIHRoaXMub25SZXNpemUgPSBkZWJvdW5jZSh0aGlzLm9uUmVzaXplLCAyMDApXG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICAvLyBDYWxsIHRoaXMgdG8gaW5pdGlhbGl6ZSBhbmQgc2V0XG4gICAgdGhpcy51cGRhdGVPblJlc2l6ZSgpXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMub25SZXNpemUsIGZhbHNlKVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMub25SZXNpemUpXG4gIH1cblxuICBpbml0aWFsaXplSGVscGVycyA9ICgpID0+IHtcbiAgICB0aGlzLmF1dG9IZWlnaHRzID0gW11cbiAgICB0aGlzLmF1dG9IZWlnaHRSZWZzID0gW11cbiAgICB0aGlzLmF2ZXJhZ2VBdXRvSGVpZ2h0ID0gdGhpcy5wcm9wcy5kZWZhdWx0SGVpZ2h0XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBmdW5jdGlvbiB3aWxsIHByb2Nlc3MgYWxsIGl0ZW1zIHRoYXQgaGF2ZSBoZWlnaHQ9XCJhdXRvXCIgc2V0LlxuICAgKiBJdCB3aWxsIGxvb3AgdGhyb3VnaCBhbGwgcmVmcyBhbmQgZ2V0IGNhbGN1bGF0ZSB0aGUgaGVpZ2h0LlxuICAgKi9cbiAgcHJvY2Vzc0F1dG9IZWlnaHRzID0gKCkgPT4ge1xuICAgIGxldCBpc1VwZGF0ZWQgPSBmYWxzZVxuXG4gICAgLy8gVGhpcyB3aWxsIGRldGVybWluZSB0aGUgYXZlcmFnZUF1dG9IZWlnaHQuXG4gICAgbGV0IHRvdGFsID0gMFxuICAgIGxldCB0b3RhbEFtb3VudCA9IDBcblxuICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgb2YgdGhlIHJlZnMgdGhhdCBoYXZlIGhlaWdodD1cImF1dG9cIi5cbiAgICB0aGlzLmF1dG9IZWlnaHRSZWZzLmZvckVhY2goKHJlZiwgaW5kZXgpID0+IHtcbiAgICAgIC8vIElmIHRoZSBoZWlnaHQgaXMgYWxyZWFkeSBjYWxjdWxhdGVkLCBza2lwIGl0LFxuICAgICAgLy8gYnV0IGNhbGN1bGF0ZSB0aGUgaGVpZ2h0IGZvciB0aGUgdG90YWwuXG4gICAgICBpZiAodGhpcy5hdXRvSGVpZ2h0c1tpbmRleF0pIHtcbiAgICAgICAgdG90YWwgKz0gdGhpcy5hdXRvSGVpZ2h0c1tpbmRleF1cbiAgICAgICAgdG90YWxBbW91bnQgKz0gMVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgLy8gTWFrZSBzdXJlIHRoZSByZWYgaGFzIGEgY2hpbGRcbiAgICAgIGlmIChcbiAgICAgICAgcmVmICYmXG4gICAgICAgIHJlZi5jaGlsZE5vZGVzICYmXG4gICAgICAgIHJlZi5jaGlsZE5vZGVzWzBdICYmXG4gICAgICAgIE51bWJlci5pc0ludGVnZXIocmVmLmNoaWxkTm9kZXNbMF0ub2Zmc2V0SGVpZ2h0KVxuICAgICAgKSB7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHJlZi5jaGlsZE5vZGVzWzBdLm9mZnNldEhlaWdodFxuXG4gICAgICAgIC8vIEFkZCB0byB0aGUgdG90YWwgdG8gY2FsY3VsYXRlIHRoZSBhdmVyYWdlQXV0b0hlaWdodC5cbiAgICAgICAgdG90YWwgKz0gaGVpZ2h0XG4gICAgICAgIHRvdGFsQW1vdW50ICs9IDFcblxuICAgICAgICAvLyBDYWNoZSB0aGUgaGVpZ2h0LlxuICAgICAgICB0aGlzLmF1dG9IZWlnaHRzW2luZGV4XSA9IGhlaWdodFxuXG4gICAgICAgIC8vIFNldCB0aGUgdXBkYXRlIGZsYWcgdG8gdHJ1ZS5cbiAgICAgICAgaXNVcGRhdGVkID0gdHJ1ZVxuICAgICAgfVxuICAgIH0pXG5cbiAgICAvLyBTYXZlIHRoZSBhdmVyYWdlIGhlaWdodC5cbiAgICB0aGlzLmF2ZXJhZ2VBdXRvSGVpZ2h0ID0gdG90YWwgLyB0b3RhbEFtb3VudFxuXG4gICAgLy8gVGhlcmUgYXJlIHNvbWUgbmV3IGhlaWdodHMgZGV0ZWN0ZWQgdGhhdCBoYWQgcHJldmlvdXNseSBub3QgYmVlbiBjYWxjdWxhdGVkLlxuICAgIC8vIENhbGwgZm9yY2VVcGRhdGUgdG8gbWFrZSBzdXJlIHRoZSB2aXJ0dWFsIGxpc3QgcmVuZGVycyBhZ2Fpbi5cbiAgICBpZiAoaXNVcGRhdGVkKSB0aGlzLmZvcmNlVXBkYXRlKClcbiAgfVxuXG4gIG9uUmVmID0gcmVmID0+IHtcbiAgICB0aGlzLnBhbmVSZWYgPSByZWZcbiAgfVxuXG4gIG9uVmlydHVhbEhlbHBlclJlZiA9IChpbmRleCwgcmVmKSA9PiB7XG4gICAgdGhpcy5hdXRvSGVpZ2h0UmVmc1tpbmRleF0gPSByZWZcblxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NBdXRvSGVpZ2h0cygpXG4gICAgfSlcbiAgfVxuXG4gIG9uUmVzaXplID0gKCkgPT4ge1xuICAgIHRoaXMudXBkYXRlT25SZXNpemUoKVxuICB9XG5cbiAgdXBkYXRlT25SZXNpemUgPSAoKSA9PiB7XG4gICAgdGhpcy5pbml0aWFsaXplSGVscGVycygpXG5cbiAgICAvLyBTaW1wbHkgcmV0dXJuIHdoZW4gd2Ugbm93IHRoZSBoZWlnaHQgb2YgdGhlIHBhbmUgaXMgZml4ZWQuXG4gICAgaWYgKHRoaXMuc3RhdGUuaXNJbnRlZ2VySGVpZ2h0KSByZXR1cm5cblxuICAgIC8vIFJldHVybiBpZiB3ZSBhcmUgaW4gYSB3ZWlyZCBlZGdlIGNhc2UgaW4gd2hpY2ggdGhlIHJlZiBpcyBubyBsb25nZXIgdmFsaWQuXG4gICAgaWYgKHRoaXMucGFuZVJlZikge1xuICAgICAgY29uc3QgY2FsY3VsYXRlZEhlaWdodCA9IHRoaXMucGFuZVJlZi5vZmZzZXRIZWlnaHRcblxuICAgICAgaWYgKGNhbGN1bGF0ZWRIZWlnaHQgPiAwKSB7XG4gICAgICAgIC8vIFNhdmUgdGhlIGNhbGN1bGF0ZWQgaGVpZ2h0IHdoaWNoIGlzIG5lZWRlZCBmb3IgdGhlIFZpcnR1YWxMaXN0LlxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICBjYWxjdWxhdGVkSGVpZ2h0XG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gUHJldmVudCB1cGRhdGVPblJlc2l6ZSBiZWluZyBjYWxsZWQgcmVjdXJzaXZlbHkgd2hlbiB0aGVyZSBpcyBhIHZhbGlkIGhlaWdodC5cbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gV2hlbiBoZWlnaHQgaXMgc3RpbGwgMCAob3IgcGFuZVJlZiBpcyBub3QgdmFsaWQpIHRyeSByZWN1cnNpdmVseSB1bnRpbCBzdWNjZXNzLlxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZU9uUmVzaXplKClcbiAgICB9KVxuICB9XG5cbiAgZ2V0SXRlbVNpemUgPSBjaGlsZHJlbiA9PiB7XG4gICAgY29uc3Qge1xuICAgICAgYWxsb3dBdXRvSGVpZ2h0LFxuICAgICAgdXNlQXZlcmFnZUF1dG9IZWlnaHRFc3RpbWF0aW9uLFxuICAgICAgZGVmYXVsdEhlaWdodFxuICAgIH0gPSB0aGlzLnByb3BzXG5cbiAgICAvLyBQcmVmZXIgdG8gcmV0dXJuIGEgYXJyYXkgb2YgYWxsIGhlaWdodHMuXG4gICAgaWYgKCFhbGxvd0F1dG9IZWlnaHQpIHtcbiAgICAgIHJldHVybiBjaGlsZHJlbi5tYXAoY2hpbGQgPT4ge1xuICAgICAgICBpZiAoIVJlYWN0LmlzVmFsaWRFbGVtZW50KGNoaWxkKSkgcmV0dXJuIGRlZmF1bHRIZWlnaHRcbiAgICAgICAgY29uc3QgeyBoZWlnaHQgfSA9IGNoaWxkLnByb3BzXG5cbiAgICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIoaGVpZ2h0KSkge1xuICAgICAgICAgIHJldHVybiBoZWlnaHRcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkZWZhdWx0SGVpZ2h0XG4gICAgICB9KVxuICAgIH1cblxuICAgIC8vIElmIGFsbG93QXV0b0hlaWdodCBpcyB0cnVlLCByZXR1cm4gYSBmdW5jdGlvbiBpbnN0ZWFkLlxuICAgIGNvbnN0IGl0ZW1TaXplRm4gPSBpbmRleCA9PiB7XG4gICAgICBpZiAoIVJlYWN0LmlzVmFsaWRFbGVtZW50KGNoaWxkcmVuW2luZGV4XSkpIHJldHVybiBkZWZhdWx0SGVpZ2h0XG4gICAgICBjb25zdCB7IGhlaWdodCB9ID0gY2hpbGRyZW5baW5kZXhdLnByb3BzXG5cbiAgICAgIC8vIFdoZW4gdGhlIGhlaWdodCBpcyBudW1iZXIgc2ltcGx5LCBzaW1wbHkgcmV0dXJuIGl0LlxuICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIoaGVpZ2h0KSkge1xuICAgICAgICByZXR1cm4gaGVpZ2h0XG4gICAgICB9XG5cbiAgICAgIC8vIFdoZW4gYWxsb3dBdXRvSGVpZ2h0IGlzIHNldCBhbmQgIHRoZSBoZWlnaHQgaXMgc2V0IHRvIFwiYXV0b1wiLi4uXG4gICAgICBpZiAoYWxsb3dBdXRvSGVpZ2h0ICYmIGNoaWxkcmVuW2luZGV4XS5wcm9wcy5oZWlnaHQgPT09ICdhdXRvJykge1xuICAgICAgICAvLyAuLi4gYW5kIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCwgcmV0dXJuIHRoZSBjYWxjdWxhdGVkIGhlaWdodC5cbiAgICAgICAgaWYgKHRoaXMuYXV0b0hlaWdodHNbaW5kZXhdKSByZXR1cm4gdGhpcy5hdXRvSGVpZ2h0c1tpbmRleF1cblxuICAgICAgICAvLyAuLi4gaWYgdGhlIGhlaWdodCBpcyBub3QgeWV0IGNhbGN1bGF0ZWQsIHJldHVybiB0aGUgYXZlcmdlXG4gICAgICAgIGlmICh1c2VBdmVyYWdlQXV0b0hlaWdodEVzdGltYXRpb24pIHJldHVybiB0aGlzLmF2ZXJhZ2VBdXRvSGVpZ2h0XG4gICAgICB9XG5cbiAgICAgIC8vIFJldHVybiB0aGUgZGVmYXVsdCBoZWlnaHQuXG4gICAgICByZXR1cm4gZGVmYXVsdEhlaWdodFxuICAgIH1cblxuICAgIHJldHVybiBpdGVtU2l6ZUZuXG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY2hpbGRyZW46IGlucHV0Q2hpbGRyZW4sXG4gICAgICBoZWlnaHQ6IHBhbmVIZWlnaHQsXG4gICAgICBkZWZhdWx0SGVpZ2h0LFxuICAgICAgYWxsb3dBdXRvSGVpZ2h0LFxuICAgICAgb3ZlcnNjYW5Db3VudCxcbiAgICAgIGVzdGltYXRlZEl0ZW1TaXplLFxuICAgICAgdXNlQXZlcmFnZUF1dG9IZWlnaHRFc3RpbWF0aW9uLFxuICAgICAgLi4ucHJvcHNcbiAgICB9ID0gdGhpcy5wcm9wc1xuXG4gICAgLy8gQ2hpbGRyZW4gYWx3YXlzIG5lZWRzIHRvIGJlIGFuIGFycmF5LlxuICAgIGNvbnN0IGNoaWxkcmVuID0gQXJyYXkuaXNBcnJheShpbnB1dENoaWxkcmVuKVxuICAgICAgPyBpbnB1dENoaWxkcmVuXG4gICAgICA6IFJlYWN0LkNoaWxkcmVuLnRvQXJyYXkoaW5wdXRDaGlsZHJlbilcblxuICAgIGNvbnN0IGl0ZW1TaXplID0gdGhpcy5nZXRJdGVtU2l6ZShjaGlsZHJlbilcblxuICAgIC8vIFZpcnR1YWxMaXN0IG5lZWRzIGEgZml4ZWQgaGVpZ2h0LlxuICAgIGNvbnN0IHsgY2FsY3VsYXRlZEhlaWdodCwgaXNJbnRlZ2VySGVpZ2h0IH0gPSB0aGlzLnN0YXRlXG5cbiAgICByZXR1cm4gKFxuICAgICAgPFBhbmVcbiAgICAgICAgZGF0YS1ldmVyZ3JlZW4tdGFibGUtYm9keVxuICAgICAgICBpbm5lclJlZj17dGhpcy5vblJlZn1cbiAgICAgICAgaGVpZ2h0PXtwYW5lSGVpZ2h0fVxuICAgICAgICBmbGV4PVwiMVwiXG4gICAgICAgIG92ZXJmbG93PVwiaGlkZGVuXCJcbiAgICAgICAgey4uLnByb3BzfVxuICAgICAgPlxuICAgICAgICA8VmlydHVhbExpc3RcbiAgICAgICAgICBoZWlnaHQ9e2lzSW50ZWdlckhlaWdodCA/IHBhbmVIZWlnaHQgOiBjYWxjdWxhdGVkSGVpZ2h0fVxuICAgICAgICAgIHdpZHRoPVwiMTAwJVwiXG4gICAgICAgICAgZXN0aW1hdGVkSXRlbVNpemU9e1xuICAgICAgICAgICAgYWxsb3dBdXRvSGVpZ2h0ICYmIHVzZUF2ZXJhZ2VBdXRvSGVpZ2h0RXN0aW1hdGlvblxuICAgICAgICAgICAgICA/IHRoaXMuYXZlcmFnZUF1dG9IZWlnaHRcbiAgICAgICAgICAgICAgOiBlc3RpbWF0ZWRJdGVtU2l6ZSB8fCBudWxsXG4gICAgICAgICAgfVxuICAgICAgICAgIGl0ZW1TaXplPXtpdGVtU2l6ZX1cbiAgICAgICAgICBvdmVyc2NhbkNvdW50PXtvdmVyc2NhbkNvdW50fVxuICAgICAgICAgIGl0ZW1Db3VudD17UmVhY3QuQ2hpbGRyZW4uY291bnQoY2hpbGRyZW4pfVxuICAgICAgICAgIHJlbmRlckl0ZW09eyh7IGluZGV4LCBzdHlsZSB9KSA9PiB7XG4gICAgICAgICAgICAvLyBJZiBzb21lIGNoaWxkcmVuIGFyZSBzdHJpbmdzIGJ5IGFjY2lkZW50LCBzdXBwb3J0IHRoaXMgZ3JhY2VmdWxseS5cbiAgICAgICAgICAgIGlmICghUmVhY3QuaXNWYWxpZEVsZW1lbnQoY2hpbGRyZW5baW5kZXhdKSkge1xuICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkcmVuW2luZGV4XSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gPGRpdiBzdHlsZT17c3R5bGV9PntjaGlsZHJlbltpbmRleF19PC9kaXY+XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmV0dXJuIDxkaXYgc3R5bGU9e3N0eWxlfT4mbmJzcDs8L2Rpdj5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gV2hlbiBhbGxvd2luZyBoZWlnaHQ9XCJhdXRvXCIgZm9yIHJvd3MsIGFuZCBhIGF1dG8gaGVpZ2h0IGl0ZW0gaXNcbiAgICAgICAgICAgIC8vIHJlbmRlcmVkIGZvciB0aGUgZmlyc3QgdGltZS4uLlxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBhbGxvd0F1dG9IZWlnaHQgJiZcbiAgICAgICAgICAgICAgUmVhY3QuaXNWYWxpZEVsZW1lbnQoY2hpbGRyZW5baW5kZXhdKSAmJlxuICAgICAgICAgICAgICBjaGlsZHJlbltpbmRleF0ucHJvcHMuaGVpZ2h0ID09PSAnYXV0bycgJiZcbiAgICAgICAgICAgICAgLy8gLi4uIGFuZCBvbmx5IHdoZW4gdGhlIGhlaWdodCBpcyBub3QgYWxyZWFkeSBiZWVuIGNhbGN1bGF0ZWQuXG4gICAgICAgICAgICAgICF0aGlzLmF1dG9IZWlnaHRzW2luZGV4XVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIC8vIC4uLiByZW5kZXIgdGhlIGl0ZW0gaW4gYSBoZWxwZXIgZGl2LCB0aGUgcmVmIGlzIHVzZWQgdG8gY2FsY3VsYXRlXG4gICAgICAgICAgICAgIC8vIHRoZSBoZWlnaHQgb2YgaXRzIGNoaWxkcmVuLlxuICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgICAgICAgIHJlZj17cmVmID0+IHRoaXMub25WaXJ0dWFsSGVscGVyUmVmKGluZGV4LCByZWYpfVxuICAgICAgICAgICAgICAgICAgZGF0YS12aXJ0dWFsLWluZGV4PXtpbmRleH1cbiAgICAgICAgICAgICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAsXG4gICAgICAgICAgICAgICAgICAgIC4uLnN0eWxlXG4gICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICAgIHtjaGlsZHJlbltpbmRleF19XG4gICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gV2hlbiBhbGxvd0F1dG9IZWlnaHQgaXMgZmFsc2UsIG9yIHdoZW4gdGhlIGhlaWdodCBpcyBrbm93bi5cbiAgICAgICAgICAgIC8vIFNpbXBseSByZW5kZXIgdGhlIGl0ZW0uXG4gICAgICAgICAgICByZXR1cm4gUmVhY3QuY2xvbmVFbGVtZW50KGNoaWxkcmVuW2luZGV4XSwge1xuICAgICAgICAgICAgICBzdHlsZVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9fVxuICAgICAgICAvPlxuICAgICAgPC9QYW5lPlxuICAgIClcbiAgfVxufVxuIl19